#!/usr/local/bin/python
import sys
import os
import json

import cgi
import cgitb
cgitb.enable(display=0,logdir="/var/www/u413/error")

sys.path.append(os.path.dirname(os.path.abspath(__file__)))
sys.path.append(os.path.dirname(os.path.abspath(__file__))+"/cmds")
print sys.path

import display
import user
import _cmd
from cmds import *

#default JSON
djson={
	"Command":"",
	"ContextText":"",
	"CurrentUser":None,
	"EditText":None,
	"SessionId":None,
	"TerminalTitle":"Terminal - Visitor",
	"ClearScreen":False,
	"Exit":False,
	"PasswordField":False,
	"ScrollToBottom":True,
	"DisplayItems":[]
}

def respond(cmd,args):
	if cmd=="":
		return json.dumps(djson)
	u=user.User()
	cmd=cmd.upper()
	if cmd in _cmd.cmds:
		return json.dumps(_cmd.cmds[cmd].response(u,args))
	else:
		tmp=u.json.copy()
		return json.dumps(tmp.update({"Command":cmd,"DisplayItems":[display.Item('"%s" is not a recognized command or is not available in the current context'%cmd)]}))

form=cgi.FieldStorage()
cli=form.getvalue("cli")
open("/var/www/u413/test.log","w").write("Form list: "+str(form.list))

if cli==None:
	cli="INITIALIZE"
if False:
	print "Status: 400"
	print "Content-Type: application/json\n\n"
	tmp=djson.copy()
	tmp["DisplayItems"]=[display.Item("Error: No cli variable provided.")]
	print json.dumps(tmp)
	exit()

cmdarg=cli.split(' ',1)

print "Content-Type: application/json\n\n"
if len(cmdarg)==1:
	print respond(cmdarg[0],"")
else:
	print respond(cmdarg[0],cmdarg[1])
